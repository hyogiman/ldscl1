<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¦¬ë”ì‹­ ê²Œì„ ê´€ë¦¬ì</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .menu-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .menu-tabs button {
      padding: 10px 16px;
      background: #eee;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .menu-tabs button.active {
      background-color: var(--primary-color);
      color: white;
    }
    .admin-tab { display: none; }
    .admin-tab.active { display: block; }
    .edit-input { width: 100px; }
  </style>
</head>
<body>
  <h1>ğŸ§  ë¦¬ë”ì‹­ ê²Œì„ ê´€ë¦¬ì</h1>

  <!-- íƒ­ ë©”ë‰´ -->
  <div class="menu-tabs">
    <button class="active" onclick="showTab('controlTab', this)">ğŸ® ê²Œì„ ì œì–´</button>
    <button onclick="showTab('teamTab', this)">ğŸ‘¥ íŒ€ ê´€ë¦¬</button>
    <button onclick="showTab('userTab', this)">ğŸ‘¤ ì°¸ê°€ì ê´€ë¦¬</button>
    <button onclick="showTab('resultTab', this)">ğŸ“Š ê²°ê³¼ ë³´ê¸°</button>
  </div>

  <!-- ğŸ® ê²Œì„ ì œì–´ -->
  <section id="controlTab" class="admin-tab active">
    <h2>ğŸ® ê²Œì„ ì œì–´</h2>
    <p>í˜„ì¬ ë¼ìš´ë“œ: <strong id="roundDisplay">-</strong></p>
    <button onclick="updateRound(-1)">â¬…ï¸ ì´ì „</button>
    <button onclick="updateRound(1)">â¡ï¸ ë‹¤ìŒ</button>
    <table>
      <thead><tr><th>ë‹¨ê³„</th><th>ìƒíƒœ</th><th>ì œì–´</th></tr></thead>
      <tbody>
        <tr><td>1ï¸âƒ£ ë¡œê·¸ì¸</td><td id="login_lock_status_text">-</td>
          <td><button onclick="setControl('login_lock', true)">ğŸ”’</button>
              <button onclick="setControl('login_lock', false)">ğŸ”“</button></td></tr>
        <tr><td>2ï¸âƒ£ ì„¤ëª…</td><td id="explain_lock_status_text">-</td>
          <td><button onclick="setControl('explain_lock', true)">ğŸ”’</button>
              <button onclick="setControl('explain_lock', false)">ğŸ”“</button></td></tr>
        <tr><td>3ï¸âƒ£ ì„ íƒ</td><td id="select_lock_status_text">-</td>
          <td><button onclick="setControl('select_lock', true)">ğŸ”’</button>
              <button onclick="setControl('select_lock', false)">ğŸ”“</button></td></tr>
        <tr><td>4ï¸âƒ£ ê²°ê³¼</td><td id="result_lock_status_text">-</td>
          <td><button onclick="setControl('result_lock', true)">ğŸ”’</button>
              <button onclick="setControl('result_lock', false)">ğŸ”“</button></td></tr>
      </tbody>
    </table>
  </section>

  <!-- ğŸ‘¥ íŒ€ ê´€ë¦¬ -->
  <section id="teamTab" class="admin-tab">
    <h2>ğŸ‘¥ íŒ€ ê´€ë¦¬</h2>
    <input type="text" id="teamNameInput" placeholder="íŒ€ ì´ë¦„" />
    <button onclick="addTeam()">íŒ€ ì¶”ê°€</button>
    <table>
      <thead><tr><th>íŒ€ëª…</th><th>ìˆ˜ì •</th><th>ì‚­ì œ</th></tr></thead>
      <tbody id="teamTableBody"></tbody>
    </table>
  </section>

  <!-- ğŸ‘¤ ì°¸ê°€ì ê´€ë¦¬ -->
  <section id="userTab" class="admin-tab">
    <h2>ğŸ‘¤ ì°¸ê°€ì ê´€ë¦¬</h2>
    <select id="teamSelect"></select>
    <input type="text" id="employeeNoInput" placeholder="ì‚¬ë²ˆ" />
    <input type="text" id="nameInput" placeholder="ì´ë¦„" />
    <button onclick="addParticipant()">ì°¸ê°€ì ì¶”ê°€</button>
    <table>
      <thead><tr><th>ì´ë¦„</th><th>ì‚¬ë²ˆ</th><th>ì—ë„ˆì§€</th><th>ì ìˆ˜</th><th>ìˆ˜ì •</th><th>ì‚­ì œ</th></tr></thead>
      <tbody id="participantTableBody"></tbody>
    </table>
  </section>

  <!-- ğŸ“Š ê²°ê³¼ ë³´ê¸° -->
  <section id="resultTab" class="admin-tab">
    <h2>ğŸ“Š íŒ€ë³„ ê²°ê³¼</h2>
    <select id="resultTeamSelect"></select>
    <button onclick="loadResults()">ì¡°íšŒ</button>
    <div id="resultTable"></div>
  </section>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script>
    const config = {
      apiKey: "AIzaSyBhI_N0bPlhaBaNXiyIHHWX5KzIznPD9fs",
      authDomain: "leadershipg-v1.firebaseapp.com",
      projectId: "leadershipg-v1",
      storageBucket: "leadershipg-v1.firebasestorage.app",
      messagingSenderId: "1069669847032",
      appId: "1:1069669847032:web:db299884387f59c58b500d"
    };
    firebase.initializeApp(config);
    const db = firebase.firestore();

    const controlRef = db.collection("round_status").doc("control");
    const roundRef = db.collection("game_state").doc("round_info");

    function showTab(id, btn) {
      document.querySelectorAll(".admin-tab").forEach(tab => tab.classList.remove("active"));
      document.querySelector(`#${id}`).classList.add("active");
      document.querySelectorAll(".menu-tabs button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    }

    function setControl(key, val) {
      const update = {}; update[key] = val;
      controlRef.set(update, { merge: true });
    }

    function watchControls() {
      controlRef.onSnapshot(doc => {
        const data = doc.data() || {};
        ['login_lock', 'explain_lock', 'select_lock', 'result_lock'].forEach(key => {
          document.getElementById(`${key}_status_text`).innerText = data[key] ? 'ì ê¸ˆ ì¤‘' : 'í•´ì œë¨';
        });
      });
    }

    function updateRound(change) {
      roundRef.get().then(doc => {
        let current = doc.data()?.current || 1;
        current = Math.max(1, current + change);
        roundRef.set({ current });
      });
    }

    function watchRound() {
      roundRef.onSnapshot(doc => {
        const r = doc.data()?.current || 1;
        document.getElementById("roundDisplay").innerText = `Round ${r}`;
      });
    }

    function addTeam() {
      const name = document.getElementById("teamNameInput").value.trim();
      if (!name) return alert("íŒ€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”");
      db.collection("teams").add({ name }).then(() => {
        document.getElementById("teamNameInput").value = "";
        loadTeams();
      });
    }

    async function loadTeams() {
      const tbody = document.getElementById("teamTableBody");
      const select = document.getElementById("teamSelect");
      const resultSelect = document.getElementById("resultTeamSelect");
      tbody.innerHTML = "";
      select.innerHTML = "<option value=''>-- íŒ€ ì„ íƒ --</option>";
      resultSelect.innerHTML = "<option value=''>-- íŒ€ ì„ íƒ --</option>";

      const snap = await db.collection("teams").get();
      const teams = [];
      snap.forEach(doc => teams.push({ id: doc.id, ...doc.data() }));
      teams.sort((a, b) => a.name.localeCompare(b.name, 'ko'));

      teams.forEach(team => {
        tbody.innerHTML += `
          <tr>
            <td><input id="teamNameInput_${team.id}" value="${team.name}" class="edit-input"/></td>
            <td><button onclick="updateTeam('${team.id}')">ìˆ˜ì •</button></td>
            <td><button onclick="deleteTeam('${team.id}')">ì‚­ì œ</button></td>
          </tr>
        `;
        select.innerHTML += `<option value="${team.id}">${team.name}</option>`;
        resultSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
      });
    }

    function updateTeam(id) {
      const name = document.getElementById("teamNameInput_" + id).value.trim();
      if (!name) return alert("íŒ€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”");
      db.collection("teams").doc(id).update({ name }).then(() => {
        alert("âœ… ìˆ˜ì • ì™„ë£Œ"); loadTeams();
      });
    }

    function deleteTeam(id) {
      if (!confirm("ì´ íŒ€ì„ ì‚­ì œí• ê¹Œìš”?")) return;
      db.collection("teams").doc(id).delete().then(loadTeams);
    }

    function addParticipant() {
      const teamId = document.getElementById("teamSelect").value;
      const empNo = document.getElementById("employeeNoInput").value.trim();
      const name = document.getElementById("nameInput").value.trim();
      if (!teamId || !empNo || !name) return alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

      db.collection("users").add({
        team_id: teamId,
        employee_no: empNo,
        name: name,
        energy: 5,
        leadership_score: 0
      }).then(() => {
        document.getElementById("employeeNoInput").value = "";
        document.getElementById("nameInput").value = "";
        loadParticipants(teamId);
      });
    }

    function loadParticipants(teamId) {
      const tbody = document.getElementById("participantTableBody");
      tbody.innerHTML = "";
      db.collection("users").where("team_id", "==", teamId).get().then(snap => {
        snap.forEach(doc => {
          const u = doc.data();
          tbody.innerHTML += `
            <tr>
              <td><input id="name_${doc.id}" value="${u.name}" class="edit-input" /></td>
              <td><input id="emp_${doc.id}" value="${u.employee_no}" class="edit-input" /></td>
              <td>${u.energy}</td>
              <td>${u.leadership_score}</td>
              <td><button onclick="updateParticipant('${doc.id}', '${teamId}')">ìˆ˜ì •</button></td>
              <td><button onclick="deleteParticipant('${doc.id}', '${teamId}')">ì‚­ì œ</button></td>
            </tr>
          `;
        });
      });
    }

    function updateParticipant(id, teamId) {
      const name = document.getElementById("name_" + id).value;
      const emp = document.getElementById("emp_" + id).value;
      db.collection("users").doc(id).update({
        name: name,
        employee_no: emp
      }).then(() => {
        alert("âœ… ì°¸ê°€ì ìˆ˜ì • ì™„ë£Œ");
        loadParticipants(teamId);
      });
    }

    function deleteParticipant(id, teamId) {
      if (!confirm("ì‚­ì œí• ê¹Œìš”?")) return;
      db.collection("users").doc(id).delete().then(() => loadParticipants(teamId));
    }

    async function loadResults() {
      const teamId = document.getElementById("resultTeamSelect").value;
      if (!teamId) return alert("íŒ€ ì„ íƒí•˜ì„¸ìš”");

      const userSnap = await db.collection("users").where("team_id", "==", teamId).get();
      const userMap = {};
      userSnap.forEach(doc => userMap[doc.id] = doc.data());

      let html = `<table><thead>
        <tr><th>ì´ë¦„</th><th>ì‚¬ë²ˆ</th><th>ë¼ìš´ë“œ</th><th>ì„ íƒ</th><th>ê³µê°</th><th>ë¦¬ë”ì‹­</th><th>ì—ë„ˆì§€</th></tr>
      </thead><tbody>`;

      for (const uid in userMap) {
        const user = userMap[uid];
        for (let i = 1; i <= 4; i++) {
          const choiceRef = db.collection("user_choices").doc(`round${i}`).collection("data").doc(uid);
          const choiceSnap = await choiceRef.get();
          const choice = choiceSnap.data();
          html += `<tr>
            <td>${user.name}</td>
            <td>${user.employee_no}</td>
            <td>Round ${i}</td>
            <td>${choice?.selected_option || '-'}</td>
            <td>${choice?.empathy_received || 0}</td>
            <td>${user.leadership_score}</td>
            <td>${user.energy}</td>
          </tr>`;
        }
      }

      html += "</tbody></table>";
      document.getElementById("resultTable").innerHTML = html;
    }

    watchControls();
    watchRound();
    loadTeams();
    document.getElementById("teamSelect").addEventListener("change", e => {
      const teamId = e.target.value;
      if (teamId) loadParticipants(teamId);
    });
  </script>
</body>
</html>
